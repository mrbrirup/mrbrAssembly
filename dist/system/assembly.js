/*mrbrAssembly 
Copyright 2019 Martin Ruppersburg
Licensed under MIT (https://github.com/mrbrirup/mrbrAssembly/blob/master/licence.md)*/var Mrbr=Mrbr||{};Mrbr.System=Mrbr.System||{},Mrbr.System.Assembly=class{constructor(){Mrbr.System.Assembly._fileReplacements=[{replace:new RegExp("^Mrbr\\."),with:"/"},{replace:new RegExp("\\.","g"),with:"/"}]}static get using(){return["Mrbr.System.ManifestEntry","Mrbr.System.Interface"]}static toObject(...e){var t=Mrbr.System.Assembly.defaultContext;const r=e.length,n=e[r-1],s=Mrbr.System.Assembly;let o;if(o=1===r?t:e[0],void 0!==s.objectCache[n])return s.objectCache[n];const i=e[r-1].split(".");let l=o;for(let e,t=0,r=i.length;t<r;t++)l=void 0!==l[e=i[t]]?l[e]:l[e]={};return Mrbr.System.Assembly[n]=l,l}static get defaultContext(){return Mrbr.System.Assembly._defaultContext}static set defaultContext(e){Mrbr.System.Assembly._defaultContext=e}static get objectCache(){return Mrbr.System.Assembly._objectCache}static isObject(...e){return void 0!==ObjectUtils.toObject(...e)}static fetchFile(e){const t=Mrbr.System.Assembly.loader;if(t.hasOwnProperty(e)){let r=t[e];return!0===r.loaded?Promise.resolve():r.promise}{let r,n,s=new Promise((e,t)=>{r=e,n=t});return fetch(e,{method:"GET"}).then(s=>s.text().then(n=>{t[e].result=n,t[e].loaded=!0,delete t[e].promise,r(n)}).catch(function(e){n(e)})).catch(function(e){n(e)}),t[e]={promise:s,result:void 0,loaded:!1},s}}static loadXmlHttpFile(e){const t=Mrbr.System.Assembly.loader;if(t.hasOwnProperty(e)){let r=t[e];return!0===r.loaded?Promise.resolve():r.promise}{let r,n,s=new Promise((e,t)=>{r=e,n=t});const o=new XMLHttpRequest;return o.open("GET",e,!0),o.send(""),o.onreadystatechange=function(){4===o.readyState&&(o.status>=200&&o.status<300?(t[e].result=o.responseText,t[e].loaded=!0,delete t[e].promise,r(o.responseText)):n(new Error(o.statusText)))},t[e]={promise:s,result:void 0,loaded:!1},s}}static loadFile(e){}static get typePropertyName(){return"mrbrAssemblyTypeName"}static addTypeNameScript(e){const t=Mrbr.System.Assembly;return`\nObject.defineProperty(${e}.prototype, '${t.typePropertyName}', { get: function() {return ${e}.${t.typePropertyName};}});\n${e}.${t.typePropertyName} = "${e}";`}static get fileReplacements(){return Mrbr.System.Assembly._fileReplacements}static set fileReplacements(e){Mrbr.System.Assembly._fileReplacements=e}static resolveNamespaceToFile(e){let t=e;for(let e,r=0,n=Mrbr.System.Assembly._fileReplacements,s=n.length;r<s;r++)e=n[r],t=`${t.split(e.replace).join(e.with)}`;return t}static nop(){}static setArrayPolyFills(){Object.getOwnPropertyDescriptor(Array.prototype,"distinct")||(Array.prototype.distinct=function(){return this.filter((e,t,r)=>r.indexOf(e)===t)}),Array.prototype.tokenSort=function(){return this.sort(function(e,t){return e.start-t.start})},Mrbr.System.Assembly.setArrayPolyFills=Mrbr.System.Assembly.nop}static get loader(){return Mrbr.System.Assembly._loader}static loadComponent(e){const t=Mrbr.System.Assembly,r=t.toObject,n=Mrbr.System.Assembly.resolveNamespaceToFile;t.loadClasses,t.setInheritance,t.addClassCtor,t.loadManifest,t.createClass;let s=n(e)+".js";return new Promise(function(n,o){t.loadFile(s).then(function(s){r(e)instanceof Function||(void 0===t._classMiddleware?createClass(e,s,t,r):t.classMiddleware.go(createClass,e,s,t,r)),n()}).catch(function(e){o(e)})})}static createClass(e,t,r,n){Function(`${e} = ${t};\n${r.addTypeNameScript(e)};\n`)(),r.objectCache[e]=n(e)}static get classMiddleware(){return Mrbr.System.Assembly._classMiddleware}static set classMiddleware(e){Mrbr.System.Assembly._classMiddleware=e}static createComponent(e,t,r,n){console.log("this.createComponent"),Function(`${e} = ${t};\ncustomElements.define('${e.toLowerCase().split(".").join("-")}', ${e});`)(),r.objectCache[e]=n(e)}static get componentMiddleware(){return Mrbr.System.Assembly._componentMiddleware}static set componentMiddleware(e){Mrbr.System.Assembly._componentMiddleware=e}static loadClass(e){let t=[e],r=e;const n=Mrbr.System.Assembly,s=n.toObject,o=Mrbr.System.Assembly.resolveNamespaceToFile,i=n.loadClasses,l=n.setInheritance,a=n.addClassCtor,c=n.loadManifest,m=n.createClass;return r=o(e)+".js",new Promise(function(o,d){n.loadFile(r).then(function(t){let r;(r=s(e))instanceof Function||(void 0===n._classMiddleware?m(e,t,n,s):n.classMiddleware.go(m,e,t,n,s))}).catch(function(t){t instanceof Error&&d({name:"Exception",error:t,source:`${n.mrbrAssemblyTypeName}:loadClass`,info:`className: ${e}`}),d(t)}).then(function(){return new Promise(function(t,r){let n=s(e).manifest;null==n||0===n.length?t():c(n).then(function(){t()}).catch(function(e){r(e)})})}).catch(function(e){d(e)}).then(function(){let r=0,n=-1,c=[];return new Promise(function(o,l){const a=s(e),m=function(){n=r;const e=[],s=[a.using,a.inherits,a.newClasses];for(let t=0,r=s.length;t<r;t++){let r=s[t];if(void 0!==r)for(let t=0,n=r.length;t<n;t++){let n=r[t];e.includes(n)||e.push(n)}}r=e.length,t=t.concat(e).distinct(),i(e).then(function(e){let t=void 0===(c=e)?0:c.length;(r+=t)!=n?m():o()}).catch(function(e){l()})};m()}).catch(function(e){d(e)}).then(function(e){const r=[];if(void 0!==t&&t.length>0)for(let e,n=0,o=t.length;n<o;n++)if((e=s(t[n]))instanceof Function){const t=new Promise(function(t,r){l(e.inherits,e).then(function(r){l(e.extends,e).then(function(r){a(e),t()})}).catch(function(e){r()})});r.push(t)}Promise.all(r).then(e=>{o()})}).catch(function(e){d(e)})})})}static loopLoadClasses(){}static loadManifest(e){if(void 0===e)return Promise.resolve();const t=Mrbr.System.Assembly,r=Mrbr.System.ManifestEntry.FileTypes,n=t.loadClass,s=t.loadScript,o=t.loadScriptElement,i=t.loadFile,l=t.loadStyleElement,a=t.createLinkedStyleElement,c=(e=Array.isArray(e)?e:[e]).length;let m=new Array(c);for(let d,y=0;y<c;y++)switch((d=e[y]).fileType){case r.Class:m[y]=new Promise(function(e,t){n(d.entryName).then(t=>e()).catch(function(e){t(e)})});break;case r.Component:m[y]=new Promise(function(e,r){t.loadComponent(d.entryName).then(t=>e()).catch(function(e){r(e)})});break;case r.Script:m[y]=new Promise(function(e,t){s(d.entryName).then(t=>e()).catch(function(e){t(e)})});break;case r.File:m[y]=new Promise(function(e,t){i(d.entryName).then(t=>e()).catch(function(e){t(e)})});break;case r.ScriptElement:m[y]=new Promise(function(e,t){o(d.entryName).then(t=>e()).catch(function(e){t(e)})});break;case r.Style:m[y]=new Promise(function(e,r){d.entryName.toLowerCase().endsWith(".css")?l(d.entryName).then(t=>e()).catch(function(e){r(e)}):l(`${t.resolveNamespaceToFile(d.entryName)}.css`).then(t=>e()).catch(function(e){r(e)})});break;case r.LinkedStyle:m[y]=new Promise(function(e,r){d.entryName.toLowerCase().endsWith(".css")?a(d.entryName).then(t=>e()).catch(function(e){r(e)}):a(`${t.resolveNamespaceToFile(d.entryName)}.css`).then(t=>e()).catch(function(e){r(e)})})}return Promise.all(m)}static loadScript(e){const t=Mrbr.System.Assembly;return new Promise(function(r,n){t.loadFile(e).then(e=>{Function(e)(),r()}).catch(function(e){n(e)})})}static loadScripts(e){if(void 0===e)return Promise.resolve();const t=this.loadFile,r=(e=Array.isArray(e)?e:[e]).lengthl,n=new Array(r);for(let s,o=0;o<r;o++)s=filenames[o],n[o]=new Promise(function(r,n){t(e).then(e=>r()).catch(function(e){n(e)})});return Promise.all(n)}static get ctorTokeniser(){return this._ctorTokeniser}static set ctorTokeniser(e){this._ctorTokeniser=e}static addClassCtor(e){if(void 0!==Object.getOwnPropertyDescriptor(e.prototype,"ctor"))return e;Mrbr.System.Assembly._ctorTokeniser||(Mrbr.System.Assembly._ctorTokeniser=new Mrbr.Utils.Parser.Tokeniser(Mrbr.System.Assembly.loader[Mrbr.System.Assembly.resolveNamespaceToFile("Mrbr.Utils.Parser.tokenCtor")+".json"].result));Mrbr.Utils.Parser.Tokeniser;const t=e.prototype.constructor.toString(),r=Mrbr.System.Assembly.ctorTokeniser.tokenise(t),n=Mrbr.Utils.Parser.Token,s=r.length,o=n.Groups,i=[];let l,a,c=[],m=!0,d=0,y=0,u=0,f=0,h=0,b=0,p=0;for(;m&&d<s;)(l=r[d]).group===o.Keyword&&"constructor"===l.type?m=!1:d++;for(m=!0;m&&d<s;)(l=r[d]).group===o.Block&&"("===l.value?(u=d,y=l.levels.parens,m=!1):d++;for(m=!0;m&&d<s;)(l=r[d]).group===o.Block&&")"===l.value&&l.levels.parens===y?(f=d,m=!1):d++;if(f>u){for(let e=u+1;e<=f-1;e++)","===(l=r[e]).value&&l.levels.parens===y?(i.push(c.join("")),c=[]):c.push(l.value);c.length>0&&i.push(c.join(""))}for(m=!0;m&&d<s;)(l=r[d]).group===o.Block&&"{"===l.value?(h=d,p=l.levels.braces,m=!1):d++;for(m=!0;m&&d<s;)(l=r[d]).group===o.Block&&"}"===l.value&&l.levels.braces===p?(b=d,m=!1):d++;if(b>h&&void 0===Object.getOwnPropertyDescriptor(e.prototype,"ctor")){a=new Array(b-1);for(let e=h+1;e<=b-1;e++)a[e]=r[e].value;Object.defineProperty(e.prototype,"ctor",{value:0===i.length?Function(`\n${a.join("").trim()}\n`):Function(i,`\n${a.join("").trim()+`/* comment ctor ${e.prototype.mrbrAssemblyTypeName} */`}\n`),configurable:!1,enumerable:!0,writable:!1})}return void 0===Object.getOwnPropertyDescriptor(e.prototype,"base")&&Object.defineProperty(e.prototype,"base",{value:function(...t){void 0!==t&&0!==t.length||((t=[])[0]={}),t[0].called=t[0].called||[];const r=this,n=t[0].called,s=r.constructor.prototype;n.push(e.prototype.mrbrAssemblyTypeName.replace(/\./g,"_")+"_ctor");for(let e in s)!n.includes(e)&&e.endsWith("_ctor")&&"ctor"!==e&&(n.push(e),r[e](...t))},configurable:!1,enumerable:!0,writable:!1,name:"base"}),void 0===Object.getOwnPropertyDescriptor(e.prototype,"bases")&&Object.defineProperty(e.prototype,"bases",{value:function(){if(void 0!==e.prototype._bases)return e.prototype._bases;const t=[this.constructor.mrbrAssemblyTypeName];return Mrbr.System.Assembly.listClassInheritance(t,this.constructor),e.prototype._bases=t,e.prototype._bases},configurable:!1,enumerable:!0,writable:!1,name:"bases"}),e}static listClassInheritance(e,t){const r=Mrbr.System.Assembly;if(t.inherits&&t.mrbrAssemblyTypeName)for(let n=0,s=t.inherits.length,o=t.inherits;n<s;n++){let t=o[n];e.includes(t)||(e.push(t),r.listClassInheritance(e,r.toObject(t)))}}static loadClasses(e){if(void 0===e||0===e.length)return Promise.resolve();const t=Mrbr.System.Assembly,r=e.length,n=new Array(r);e=Array.isArray(e)?e:[e];for(let s,o=0;o<r;o++)s=e[o],n[o]=new Promise(function(e,r){t.loadClass(s).then(function(t){e(s)}).catch(function(e){r(e)})});return Promise.all(n)}static loadConfigFile(e){const t=Mrbr.System.Assembly;return new Promise(function(r,n){t.loadFile(e).then(n=>{t.loader[e].config=JSON.parse(n),r()}).catch(function(e){n(e)})})}static loadConfigFiles(e){if(void 0===e||0===classes.length)return Promise.resolve();const t=Mrbr.System.Assembly,r=(e=Array.isArray(e)?e:[e]).length,n=new Array(r);for(let s,o=0;o<r;o++)s=e[o],n[o]=new Promise(function(e,r){t.loadConfigFile(s).then(function(t){e(s)}).catch(function(e){r(e)})});return Promise.all(n)}static loadStyleElement(e){const t=Mrbr.System.Assembly;return new Promise(function(r,n){t.loadFile(e).then(e=>{let t=document.createElement("style");t.type="text/css",t.styleSheet?t.styleSheet.cssText=e:t.appendChild(document.createTextNode(e)),document.head.appendChild(t),r()}).catch(function(e){n(e)})})}static loadStyleElements(e){if(void 0===e||0===e.length)return Promise.resolve();const t=Mrbr.System.Assembly,r=(e=Array.isArray(e)?e:[e]).length,n=new Array(r);for(let s,o=0;o<r;o++)s=e[fileNameCounter],n[fileNameCounter]=new Promise(function(e,r){t.loadStyleElement(filename).then(function(t){e(filename)}).catch(function(e){r(e)})});return Promise.all(n)}static loadScriptElement(e){const t=Mrbr.System.Assembly;return new Promise(function(r,n){t.loadFile(e).then(t=>{let n=document.createElement("script");n.id=e,n.text=t,document.head.appendChild(n),r()}).catch(function(e){n(e)})})}static loadScriptElements(e){if(void 0===e||0===e.length)return Promise.resolve();const t=Mrbr.System.Assembly,r=(e=Array.isArray(e)?e:[e]).length,n=new Array(r);for(let e,s=0;fileNamesCounter<r;s++)e=e[s],n[s]=new Promise(function(e,r){t.loadScriptElement(filename).then(function(t){e(filename)}).catch(function(e){r(e)})});return Promise.all(n)}static createLinkedScriptElement(e){let t=document.createElement("script");return t.id=e,t.src=e,document.head.appendChild(t),Promise.resolve()}static createLinkedScriptElements(e){if(void 0===filenames||0===filenames.length)return Promise.resolve();const t=Mrbr.System.Assembly;e=Array.isArray(filenames)?filenames:[filenames];let r=new Array(filenames.length);for(let n=0,s=e.length,o=filenames[n];n<s;n++)r[n]=new Promise(function(e,r){t.createLinkedScriptElement(o).then(function(t){e(o)}).catch(function(e){r(e)})});return Promise.all(r)}static createLinkedStyleElement(e){let t=document.createElement("link");return t.type="text/css",t.rel="stylesheet",t.href=e,document.head.appendChild(t),Promise.resolve()}static createLinkedStyleElements(e){if(void 0===filenames||0===filenames.length)return Promise.resolve();const t=Mrbr.System.Assembly;e=Array.isArray(filenames)?filenames:[filenames];let r=new Array(filenames.length);for(let n=0,s=e.length,o=filenames[n];n<s;n++)r[n]=new Promise(function(e,r){t.createLinkedStyleElement(o).then(function(t){e(o)}).catch(function(e){r(e)})});return Promise.all(r)}static loadInterface(e){let t=e;const r=Mrbr.System.Assembly,n=r.toObject,s=Mrbr.System.Assembly.resolveNamespaceToFile,o=r.loadClasses,i=r.loadInterfaces,l=r.loadManifest;return t=s(e),t+=".json",new Promise(function(s,a){r.loadFile(t).then(function(t){let c=n(e);void 0===c.mrbrInterfaceName&&((c=Object.assign(c,JSON.parse(t))).mrbrInterfaceName=e);let m=[];c.inherits&&c.inherits.length>0&&m.push(i(c.inherits)),c.using&&c.using.length>0&&m.push(o(c.using)),c.interfaces&&c.interfaces.length>0&&m.push(i(c.interfaces)),c.manifest&&c.manifest.length>0&&m.push(l(c.manifest)),Promise.all(m).then(()=>{r.setInterfaceInheritance(c.inherits,e),s()}).catch(function(e){a(e)})})})}static loadInterfaces(e){if(void 0===e||0===e.length)return Promise.resolve();const t=Mrbr.System.Assembly;e=Array.isArray(e)?e:[e];let r=new Array(e.length);for(let n=0,s=e.length,o=e[n];n<s;n++)r[n]=new Promise(function(e,r){t.loadInterface(o).then(function(t){e(o)}).catch(function(e){r(e)})});return Promise.all(r)}static setInterfaceInheritance(e,t){if(void 0===e)return;e=Array.isArray(e)?e:[e];const r=Mrbr.System.Assembly,n=r.toObject(t);n.inherited||(n.inherited=[]);for(let t,s=0,o=e.length,i=r.toObject(t);s<o;s++)t=e[s],n.inherited.includes(t)||(n.inherited.push(t),i.inherited&&(n.inherited=n.inherited.concat(i.inherited)),i.properties&&(n.properties=Object.assign(n.properties,i.properties)),i.methods&&(n.methods=Object.assign(n.methods,i.methods)))}static setInheritance(e,t){return void 0===e?Promise.resolve():Mrbr.System.Inheritance.applyInheritance(e,t)}static initialised(e){const t=Mrbr.System.Assembly;if(e&&void 0!==e.loadFile?Mrbr.System.Assembly.loadFile=e.loadFile:(window&&window.fetch,Mrbr.System.Assembly.loadFile=Mrbr.System.Assembly.loadXmlHttpFile),e&&e.defaultContext)Mrbr.System.Assembly._defaultContext=e.defaultContext;else if("undefined"==typeof window)if("undefined"!=typeof globalThis)Mrbr.System.Assembly._defaultContext=globalThis;else{if("undefined"==typeof global)throw"No global";Mrbr.System.Assembly._defaultContext=global}else window?Mrbr.System.Assembly._defaultContext=window:Mrbr.System.Assembly._defaultContext=void 0;return null!=e&&void 0!==e.assemblyResolvers&&null!==e.assemblyResolvers&&(t.fileReplacements=e.assemblyResolvers),t._loader={},t._objectCache={},t.setArrayPolyFills(),new Promise(function(e,r){t.loadFile(Mrbr.System.Assembly.resolveNamespaceToFile("Mrbr.Utils.Parser.tokenCtor")+".json").then(()=>t.loadClass("Mrbr.Utils.Parser.Tokeniser")).then(()=>t.loadClass("Mrbr.System.Middleware")).then(()=>{t._classMiddleware=new Mrbr.System.Middleware}).catch(e=>console.log(e)).then(()=>t.loadClass("Mrbr.System.ManifestEntry")).then(()=>t.loadClass("Mrbr.System.Inheritance")).then(()=>t.loadClass("Mrbr.System.Exception")).then(function(){return Function(t.addTypeNameScript("Mrbr.System.Assembly"))(),t.loadClasses(t.using)}).then(function(){e()}).catch(function(e){r(e)})})}static onReady(e,t){let r,n=function(){document.removeEventListener?(document.removeEventListener("DOMContentLoaded",n),document.removeEventListener("load",n),window.removeEventListener("load",n),window.removeEventListener("DOMContentLoaded",n)):(document.detachEvent("onreadystatechange",n),window.detachEvent("onload",n),window.detachEvent("load",n),document.detachEvent("load",n)),r()};return new Promise(function(t,s){r=t,Mrbr.System.Assembly.initialised(e).then(function(){document.onreadystatechange=function(){"complete"===document.readyState&&n()},"complete"===document.readyState?t("complete"):document.addEventListener?(document.addEventListener("DOMContentLoaded",n),window.addEventListener("load",n),window.addEventListener("DOMContentLoaded",n),document.addEventListener("load",n)):(document.attachEvent("onreadystatechange",n),window.attachEvent("onload",n),document.attachEvent("load",n),window.attachEvent("load",n))})})}static createNamespaceManifest(e,t,r){if(void 0===e||void 0===t||void 0===r||0===r.length)return[];const n=r.length;let s=new Array(n),o=Mrbr.System.ManifestEntry;for(let i=0;i<n;i++)s[i]=new o(t,`${e}.${r[i]}`);return s}};